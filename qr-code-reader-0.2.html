<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Barcode Reader & PDF Splitter</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #2c3e50;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            width: 95%;
            max-width: 900px;
        }
        h2 { margin-top: 0; color: #2c3e50; }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #bdc3c7;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            background-color: #ecf0f1;
        }
        .upload-area:hover {
            border-color: #3498db;
            background-color: #e8f6fc;
        }
        
        /* Result Area */
        #result-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            word-break: break-all;
            text-align: left;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* PDF Controls (Toolbar) */
        #pdf-controls {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å */
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
            text-align: center;
        }
        
        /* Gallery Grid */
        #pdf-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* Thumbnail Card */
        .page-card {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: 0.2s;
            width: 140px;
            background: white;
        }
        .page-card.selected {
            border-color: #28a745;
            background-color: #e9f7ef;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }
        .page-thumb {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }
        
        /* Checkbox Styling */
        .page-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }
        .page-label {
            font-size: 14px;
            padding: 5px;
            background: #f1f1f1;
            border-top: 1px solid #ddd;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            color: white;
            transition: 0.2s;
        }
        .btn-primary { background-color: #3498db; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-secondary { background-color: #6c757d; }

    </style>
</head>
<body>

    <div class="container">
        <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô All-in-One + ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF</h2>
        
        <div class="upload-area" id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p>üìÇ <b>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</b> (PDF ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR)<br>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á</p>
        </div>
        <input type="file" id="file-input" accept="image/*,application/pdf" style="display: none;">

        <div id="result-area"></div>

        <div id="pdf-controls">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 1-3, 5): </label>
            <input type="text" id="page-range" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-3, 5">
            <button class="btn btn-primary" onclick="applyPageRange()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∏</button>
            <button class="btn btn-secondary" onclick="selectAll(true)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-secondary" onclick="selectAll(false)">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            <div style="flex-basis: 100%; height: 0;"></div> <button class="btn btn-success" onclick="downloadSelectedPages()">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (PDF)</button>
        </div>

        <div id="pdf-preview"></div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        const { PDFDocument } = PDFLib; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Library PDF-Lib

        const html5QrCode = new Html5Qrcode("drop-zone");
        const resultArea = document.getElementById('result-area');
        const pdfPreview = document.getElementById('pdf-preview');
        const pdfControls = document.getElementById('pdf-controls');
        
        let currentPdfBytes = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠
        let totalPages = 0;

        // --- 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô QR Code ---
        const scanImageFile = (imageFile) => {
            resultArea.style.display = 'block';
            resultArea.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô QR Code...";
            resultArea.className = 'loading';

            html5QrCode.scanFileV2(imageFile, true)
            .then(decodedResult => {
                const text = decodedResult.decodedText;
                let html = `‚úÖ <b>‡∏≠‡πà‡∏≤‡∏ô QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b><br>`;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Link ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                try {
                    new URL(text);
                    html += `<a href="${text}" target="_blank" style="font-size:1.2em; color:#0056b3; font-weight:bold;">üîó ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: ${text}</a><br>`;
                    html += `<small style="color:red;">*‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤</small>`;
                } catch (e) {
                    html += `‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: <b>${text}</b>`;
                }
                resultArea.innerHTML = html;
                resultArea.className = 'success';
            })
            .catch(err => {
                resultArea.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö QR Code ‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ";
                resultArea.className = 'error';
            });
        };

        // --- 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PDF ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Thumbnails ---
        const handlePdf = async (file) => {
            resultArea.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏• QR ‡πÄ‡∏Å‡πà‡∏≤
            pdfPreview.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• PDF...";
            pdfControls.style.display = 'none';

            try {
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global (ArrayBuffer)
                currentPdfBytes = await file.arrayBuffer(); 
                
                // ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                const pdf = await pdfjsLib.getDocument(currentPdfBytes).promise;
                totalPages = pdf.numPages;

                pdfPreview.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                pdfControls.style.display = 'flex'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 }); // ‡∏£‡∏π‡∏õ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    const card = document.createElement('div');
                    card.className = 'page-card';
                    card.dataset.pageNum = i;
                    card.onclick = (e) => {
                        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ó‡∏µ‡πà checkbox ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á) ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö checkbox
                        if (e.target.type !== 'checkbox') {
                            const cb = card.querySelector('.page-checkbox');
                            cb.checked = !cb.checked;
                            toggleSelectionStyle(card, cb.checked);
                        }
                    };

                    // Checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'page-checkbox';
                    checkbox.value = i;
                    checkbox.onchange = () => toggleSelectionStyle(card, checkbox.checked);

                    // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    img.className = 'page-thumb';

                    // ‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤
                    const label = document.createElement('div');
                    label.className = 'page-label';
                    label.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${i}`;

                    card.appendChild(checkbox);
                    card.appendChild(img);
                    card.appendChild(label);
                    pdfPreview.appendChild(card);
                }
            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF");
            }
        };

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function toggleSelectionStyle(card, isChecked) {
            if (isChecked) card.classList.add('selected');
            else card.classList.remove('selected');
        }

        // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á (Range Input) ---
        function applyPageRange() {
            const input = document.getElementById('page-range').value;
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            selectAll(false);

            const parts = input.split(',');
            parts.forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡πà‡∏ß‡∏á ‡πÄ‡∏ä‡πà‡∏ô 1-3
                    const [start, end] = part.split('-').map(Number);
                    for (let i = start; i <= end; i++) {
                        checkPage(i);
                    }
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÄ‡∏ä‡πà‡∏ô 5
                    checkPage(Number(part));
                }
            });
        }

        function checkPage(pageNum) {
            if (pageNum < 1 || pageNum > totalPages) return;
            const card = document.querySelector(`.page-card[data-page-num="${pageNum}"]`);
            if (card) {
                const cb = card.querySelector('.page-checkbox');
                cb.checked = true;
                toggleSelectionStyle(card, true);
            }
        }

        function selectAll(select) {
            document.querySelectorAll('.page-checkbox').forEach(cb => {
                cb.checked = select;
                toggleSelectionStyle(cb.parentElement, select);
            });
        }

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!) ---
        async function downloadSelectedPages() {
            // ‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const checkboxes = document.querySelectorAll('.page-checkbox:checked');
            if (checkboxes.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡∏ô‡πâ‡∏≤");
                return;
            }

            const pageNumbers = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ pdf-lib
                const pdfDoc = await PDFDocument.load(currentPdfBytes);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏´‡∏°‡πà
                const newPdf = await PDFDocument.create();

                // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö 1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ index ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0)
                const pagesToCopy = pageNumbers.map(n => n - 1);
                const copiedPages = await newPdf.copyPages(pdfDoc, pagesToCopy);

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                copiedPages.forEach(page => newPdf.addPage(page));

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `selected_pages_${new Date().getTime()}.pdf`;
                link.click();

            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF");
            }
        }

        // --- Main Handler ---
        const handleFile = (file) => {
            if (!file) return;
            if (file.type === "application/pdf") {
                handlePdf(file);
            } else {
                scanImageFile(file);
            }
        };

        document.getElementById('file-input').addEventListener('change', e => handleFile(e.target.files[0]));
        document.addEventListener('paste', e => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file') handleFile(item.getAsFile());
            }
        });

    </script>
</body>
</html>